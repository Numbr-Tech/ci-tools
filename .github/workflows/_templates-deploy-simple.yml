name: deploy

on:
  workflow_call:
    inputs:
      PROJECT_NAME:
        description: 'Project name'
        required: true
        type: string
      AZURE_LOCATION:
        description: 'Azure location'
        required: false
        type: string
        default: 'francecentral'
      AZURE_SHARED_RESOURCE_GROUP:
        description: 'Azure shared resource group'
        required: false
        type: string
        default: 'rg-frc-pprodgeneral'
      AZURE_VNET_NAME:
        description: ''
        required: false
        type: string
        default: ''
      AZURE_SUBNET_NAME:
        description: ''
        required: false
        type: string
        default: ''
      INGRESS_PORT:
        description: 'Ingress port'
        required: false
        type: string
        default: '80'
      INGRESS_EXTERNAL:
        description: 'Ingress external'
        required: false
        type: boolean
        default: true
      RESOURCE_CPU:
        description: 'Resource CPU'
        required: false
        type: string
        default: '0.5'
      RESOURCE_MEMORY:
        description: 'Resource memory'
        required: false
        type: string
        default: '1.0Gi'
      SCALE_MIN_REPLICATS:
        description: 'Scale min replicats'
        required: false
        type: string
        default: '1'
      SCALE_MAX_REPLICATS:
        description: 'Scale max replicats'
        required: false
        type: string
        default: '1'
      SCALE_CONCURRENT_REQUEST:
        description: 'Scale concurrent request'
        required: false
        type: string
        default: '30'
      AZURE_VAULT_NAME:
        description: 'Azure vault name'
        required: false
        type: string
        default: 'vault-frc-iac'
      IMAGE_TAG:
        description: 'Image tag'
        required: false
        type: string
        default: '${{ github.sha }}'
      INFRA_ENV:
        description: 'Infra environment'
        required: false
        type: string
        default: "${{ github.ref_name == 'main' && 'production' || 'staging' }}"
      DEBUG:
        description: 'Enable debug mode (verbose logs)'
        required: false
        type: boolean
        default: false
    secrets:
      AZURE_CLIENT_ID:
        description: 'GitHub App private key'
        required: true
      AZURE_TENANT_ID:
        description: 'azure tenant id'
        required: true
      AZURE_SUBSCRIPTION_ID_PROD:
        description: 'azure subscription id prod'
        required: true
      AZURE_SUBSCRIPTION_ID_PPROD:
        description: 'azure subscription id pprod'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_REGISTRY: ${{ inputs.INFRA_ENV == 'production' && 'nbtreg' || 'pprodnbtregistry' }}
      AZURE_REGISTRY_FQDN: ${{ inputs.INFRA_ENV == 'production' && 'nbtreg' || 'pprodnbtregistry-aucgecdkece6b5d7' }}.azurecr.io
      AZURE_CONTAINERAPP_ENVIRONMENT_NAME: ${{ inputs.PROJECT_NAME }}-${{ inputs.INFRA_ENV == 'production' && 'production' || 'staging' }}-workspace
      AZURE_RESOURCE_GROUP: rg-frc-${{ inputs.PROJECT_NAME }}
      AZURE_SUBSCRIPTION_ID: ${{ inputs.INFRA_ENV == 'production' && secrets.AZURE_SUBSCRIPTION_ID_PROD || secrets.AZURE_SUBSCRIPTION_ID_PPROD }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: debug
        if: inputs.DEBUG == 'true'
        run: |
            echo "AZURE_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}"
            echo "AZURE_RESOURCE_GROUP: ${{ env.AZURE_RESOURCE_GROUP }}"
            echo "AZURE_CONTAINERAPP_ENVIRONMENT_NAME: ${{ env.AZURE_CONTAINERAPP_ENVIRONMENT_NAME }}"
            echo "AZURE_REGISTRY_FQDN: ${{ env.AZURE_REGISTRY_FQDN }}"
            echo "AZURE_REGISTRY: ${{ env.AZURE_REGISTRY }}"
            echo "IMAGE_TAG: ${{ inputs.IMAGE_TAG }}"
            echo "INGRESS_PORT: ${{ inputs.INGRESS_PORT }}"
            echo "INGRESS_EXTERNAL: ${{ inputs.INGRESS_EXTERNAL }}"
            echo "RESOURCE_CPU: ${{ inputs.RESOURCE_CPU }}"
            echo "RESOURCE_MEMORY: ${{ inputs.RESOURCE_MEMORY }}"
            echo "SCALE_MIN_REPLICATS: ${{ inputs.SCALE_MIN_REPLICATS }}"
            echo "SCALE_MAX_REPLICATS: ${{ inputs.SCALE_MAX_REPLICATS }}"
            echo "SCALE_CONCURRENT_REQUEST: ${{ inputs.SCALE_CONCURRENT_REQUEST }}"
            echo "AZURE_VAULT_NAME: ${{ inputs.AZURE_VAULT_NAME }}"
            echo "INFRA_ENV: ${{ inputs.INFRA_ENV }}"
            echo "DEBUG: ${{ inputs.DEBUG }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ env.AZURE_REGISTRY }}

      - name: Build and Push Docker image
        run: |
          IMAGE_PATH=${{ env.AZURE_REGISTRY_FQDN }}/${{ inputs.PROJECT_NAME }}:${{ inputs.IMAGE_TAG }}
          docker build -t ${IMAGE_PATH} . ${{ inputs.debug == 'true' && '' || '--quiet' }}
          docker push ${IMAGE_PATH}

      - name: Create Container App Environment if missing
        run: |
          echo "ðŸ” Checking if Container App environment ${{ env.AZURE_CONTAINERAPP_ENVIRONMENT_NAME }} exists..."
          if az containerapp env show \
            --name "${{ env.AZURE_CONTAINERAPP_ENVIRONMENT_NAME }}" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --query "name" \
            --only-show-errors > /dev/null 2>&1; then
            echo "âœ… Container App environment '${{ env.AZURE_CONTAINERAPP_ENVIRONMENT_NAME }}' already exists"
          else
            echo "ðŸ—ï¸ Creating Container App environment '${{ env.AZURE_CONTAINERAPP_ENVIRONMENT_NAME }}'..."
            az containerapp env create \
                --name "${{ env.AZURE_CONTAINERAPP_ENVIRONMENT_NAME }}" \
                --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
                --location "${{ inputs.AZURE_LOCATION }}" \
                --internal-only true \
                $([ -n "${{ inputs.AZURE_VNET_NAME }}" ] && [ -n "${{ inputs.AZURE_SUBNET_NAME }}" ] && echo "--infrastructure-subnet-resource-id \"/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.Network/virtualNetworks/${{ inputs.AZURE_VNET_NAME }}/subnets/${{ inputs.AZURE_SUBNET_NAME}}\"")
            echo "âœ… Container App environment created successfully"
          fi

      - name: Build containerapp.yaml
        run: |
          sed -e "s|__PROJECT_NAME__|${{ inputs.PROJECT_NAME }}|g" \
              -e "s|__AZURE_LOCATION__|${{ inputs.AZURE_LOCATION }}|g" \
              -e "s|__AZURE_SUBSCRIPTION_ID__|${{ env.AZURE_SUBSCRIPTION_ID }}|g" \
              -e "s|__AZURE_SHARED_RESOURCE_GROUP__|${{ inputs.AZURE_SHARED_RESOURCE_GROUP }}|g" \
              -e "s|__AZURE_RESOURCE_GROUP__|${{ env.AZURE_RESOURCE_GROUP }}|g" \
              -e "s|__AZURE_CONTAINERAPP_ENVIRONMENT_NAME__|${{ env.AZURE_CONTAINERAPP_ENVIRONMENT_NAME }}|g" \
              -e "s|__AZURE_REGISTRY_FQDN__|${{ env.AZURE_REGISTRY_FQDN }}|g" \
              -e "s|__IMAGE_TAG__|${{ inputs.IMAGE_TAG }}|g" \
              -e "s|__INGRESS_PORT__|${{ inputs.INGRESS_PORT }}|g" \
              -e "s|__INGRESS_EXTERNAL__|${{ inputs.INGRESS_EXTERNAL }}|g" \
              -e "s|__RESOURCE_CPU__|${{ inputs.RESOURCE_CPU }}|g" \
              -e "s|__RESOURCE_MEMORY__|${{ inputs.RESOURCE_MEMORY }}|g" \
              -e "s|__SCALE_MIN_REPLICATS__|${{ inputs.SCALE_MIN_REPLICATS }}|g" \
              -e "s|__SCALE_MAX_REPLICATS__|${{ inputs.SCALE_MAX_REPLICATS }}|g" \
              -e "s|__SCALE_CONCURRENT_REQUEST__|${{ inputs.SCALE_CONCURRENT_REQUEST }}|g" \
              -e "s|__AZURE_VAULT_NAME__|${{ inputs.AZURE_VAULT_NAME }}|g" \
              -e "s|__INFRA_ENV__|${{ inputs.INFRA_ENV }}|g" \
              Infra/containerapp.yaml.tpl > Infra/containerapp.yaml
          if [ "${{ inputs.DEBUG }}" = "true" ]; then
            cat Infra/containerapp.yaml
          fi

      - name: Deploy Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          azureCredentials: ${{ secrets.AZURE_CREDENTIALS }}
          containerAppName: ${{ inputs.PROJECT_NAME }}
          imageToDeploy: ${{ env.AZURE_REGISTRY_FQDN }}/${{ inputs.PROJECT_NAME }}:${{ inputs.IMAGE_TAG }}
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          yamlConfigPath: ./Infra/containerapp.yaml
